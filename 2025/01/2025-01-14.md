# Effective Java

# Item 85. 자바 직렬화의 대안을 찾으라

- 자바 직렬화는 설계적으로 여러 심각한 문제를 내포하고 있다.
    - 특히 보안, 성능, 유지보수성 측면에서 취약하다.
- 새로운 시스템에서는 자바의 직렬화를 절대 사용하지 않고 JSON이나 프로토콜 버퍼 같은 대체 기술을 사용하는 것을 권장한다.
    - 만약 직렬화를 반드시 사용해야 한다면 안전하게 사용하기 위한 적절한 방어 기법을 사용해야 한다.

## 직렬화의 문제점

- 공격 범위가 너무 넓기 때문에 대처가 어렵다.
    - `ObjectInputStream.readObject()` 메서드는 거의 모든 타입의 객체를 생성하고 실행 가능하다.
    - 즉, 모든 코드가 공격 범위에 포함되기 때문에 역직렬화 시 악의적으로 조작된 바이트 스트림이 전달되면 원격 코드 실행(RCE), 서비스 거부(DOS) 등 치명적인 보안 문제가 발생할 수 있다.
- 가젯(Gadget) 문제를 고려해야 한다.
    - 여기서 가젯은 자바 직렬화 및 역직렬화 공격에서 사용되는 악의적으로 조작된 객체를 의미한다.
    - 즉, 라이브러리나 코드에서 취약점을 가진 메서드들을 조합한 가젯 체인으로 역직렬화 공격을 받을 수 있다.
- 대량의 역직렬화 요청으로 인해 오류가 발생할 수 있다.
    - 작은 크기의 직렬화 스트림을 입력으로 역직렬화 시도 시 과도한 계산량 발생으로 서비스 거부 상태(DOS)를 유발할 수 있다.
- 보안적으로 취약하다.
    - 공격자들은 자바 표준 라이브러리뿐 아니라 서드파티 라이브러리, 애플리케이션 클래스에서 잠재적 취약점들을 연계한 공격할 수 있다.
- 결론적으로 신뢰할 수 없는 데이터의 역직렬화는 본질적으로 위험하다!

## 권장 사항

- 반드시 필요한 상황이 아니라면 직렬화를 사용하지 않아야 한다.
- 다음과 같은 상황에서 역직렬화하지 않아야 한다.
    - 먼저 신뢰하지 않는 데이터는 절대 역직렬화를 해서는 안 된다.
    - 특히 RMI, JMX, JMS 등과 같은 자바 하위 시스템에서 들어오는 데이터를 역직렬화하지 않도록 차단해야 한다.
- 상황에 따라서 ObjectInputFilter 사용하는 것도 괜찮다.
    - 자바 9에서는 `java.io.ObjectInputFilter`를 통해 역직렬화 전에 허용/거부할 클래스를 필터링할 수 있다.
    - 알려진 안전한 클래스만 허용하는 **화이트리스트 방식**과 특정 위험 클래스만 거부하는 **블랙리스트 방식**이 존재한다. 그 중 화이트 리스트 방식이 좀 더 보안적으로 권장된다.
    - 그렇지만 대량의 역직렬화 요청을 막지 못하기 때문에 제한적 방어 방법이다.
- 현실적인 이유로 자바 직렬화 시스템을 계속 유지해야 한다면 안전한 방어 수단을 추가하고 점진적으로 직렬화를 대체하는 기술로 마이그레이션을 검토해야 한다.

### 대안 기술

- **JSON**
    - 텍스트 기반 데이터 표현으로 사람이 읽을 수 있다.
    - 단순한 데이터 교환 시 적합하다.
    - 직관적이고 이해가 쉽지만 텍스트 기반이기 때문에 효율성은 상대적으로 낮다.
- **프로토콜 버퍼(Protocol Buffers)**
    - 구글이 설계한 효율적인 바이너리 데이터 교환 포맷이다.
    - 데이터 스키마 정의(타입 강제) 가능하다.
    - 높은 성능, 안정적이지만 바이너리 기반으로 사람이 직접 읽기 어렵다는 단점도 존재한다.