# Effective Java

# Item 88. readObject 메서드는 방어적으로 작성하라

- `readObject` 메서드는 public 생성자를 작성하는 것과 동일한 주의가 필요하다.
    - `readObject`는 직렬화로 생성된 바이트 스트림을 풀어 객체를 생성하는 메서드로, 사실상 **객체 생성자와 동일한 역할**을 수행한다.
        - 따라서, 일반적인 생성자에서 객체의 상태를 초기화할 때처럼 **객체의 일관성과 유효성을 보장**하기 위해 방어적 설계가 필요하다.
    - 이를 소홀히 하면 공격자는 임의의 바이트 스트림을 제공함으로써 생성자에서는 불가능한 불변식이 깨진 객체를 만들어낼 수 있다.
- `readObject`는 역직렬화 시 불변성과 유효성을 유지해야 하며 전달된 바이트 스트림을 신뢰해서는 안 된다.
    - 역직렬화는 신뢰할 수 없는 출처의 바이트 스트림으로 객체를 재구성할 수 있는 과정이다.
    - 정상적인 직렬화된 데이터라고 가정하더라도 이는 외부 사용자에 의해 변조되었을 가능성도 있기 때문에 조심해야 한다.
- 가변 객체 참조는 반드시 아래의 조치를 취해야 한다.
    - **방어적 복사**
        - 역직렬화 시 내부 필드가 외부에서 접근 가능한 가변 객체를 참조하면, 해당 참조를 통해 불변 객체 내부 상태를 변경할 수 있게 된다.
    - **불변식 검증**
        - 직렬화 데이터를 역직렬화한 후 해당 객체의 상태가 클래스의 요구 조건(불변식)을 만족하도록 해야 한다.
        - 불변식은 객체의 상태가 프로그램 내에서 항상 유효한지 검증하는 핵심 규칙이다.
    - **재정의 가능 메서드 호출 금지**
        - `readObject`에서는 재정의 가능한 메서드를 호출하면 **하위 클래스의 상태가 완전히 역직렬화되지 않은 상태**에서 메서드가 실행될 위험이 있다.

## readObject 주의 사항

- `readObject`는 역직렬화된 데이터를 사용하는 메서드로 public 생성자에서와 동일한 수준으로 유효성 검사를 해야 한다.
    - 잘못된 데이터가 포함된 바이트 스트림이 넘어올 수 있으므로 이를 신뢰해서는 안 된다.
- 가변 객체는 방어적으로 복사해야 한다.
    - private이어야 하는 가변 객체 참조 필드는 방어적 복사를 수행해야 한다.
    - 불변 클래스라도 내부적으로 가변 객체를 참조한다면 방어적 복사를 하지 않는다면 의도치 못한 이슈가 발생할 수 있기 때문에 주의해야 한다.
- 불변식 유효성 검사를 반드시 수행해야 한다.
    - 역직렬화된 객체가 예상하는 불변식을 만족하는지 반드시 확인해야 한다.
    - 유효하지 않은 경우에는 `InvalidObjectException`같은 예외를 발생시켜 비정상적인 상황임을 감지해야 한다.
- 재정의 가능한 메서드는 호출하지 않아야 한다.
    - `readObject` 메서드 내에서 재정의 가능 메서드를 호출하지 않아야 한다.
    - 호출 시 하위 클래스에서 상태가 완전히 초기화되지 않은 상태에서 실행될 가능성이 있으며 이는 예기치 못한 동작으로 이어진다.
- 역직렬화 후 객체 그래프 전체의 유효성을 검사해야 한다면 ObjectInputValida tion 인터페이스를 사용하는 것을 권장한다.
- 기본 직렬화 형태를 사용해도 불변성을 깨뜨릴 가능성이 있고 커스텀 직렬화에서도 같은 문제가 발생할 수 있음을 인지해야 한다